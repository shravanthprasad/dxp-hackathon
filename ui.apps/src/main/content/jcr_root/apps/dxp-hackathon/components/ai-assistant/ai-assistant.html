<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.11.338/pdf.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<sly data-sly-use.clientlib="core/wcm/components/commons/v1/templates/clientlib.html">
    <sly data-sly-call="${clientlib.js @ categories='dxp-hackathon.site', async=true}"/>
</sly>
<style>
    .modal-dialog {
        cursor: move;
    }
</style>
<!-- Button to trigger the modal -->
<button type="button" class="btn btn-primary js-viewer-modal" data-toggle="modal" data-target="#myModal">
    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-chat"
         viewBox="0 0 16 16">
        <path d="M2.678 11.894a1 1 0 0 1 .287.801 11 11 0 0 1-.398 2c1.395-.323 2.247-.697 2.634-.893a1 1 0 0 1 .71-.074A8 8 0 0 0 8 14c3.996 0 7-2.807 7-6s-3.004-6-7-6-7 2.808-7 6c0 1.468.617 2.83 1.678 3.894m-.493 3.905a22 22 0 0 1-.713.129c-.2.032-.352-.176-.273-.362a10 10 0 0 0 .244-.637l.003-.01c.248-.72.45-1.548.524-2.319C.743 11.37 0 9.76 0 8c0-3.866 3.582-7 8-7s8 3.134 8 7-3.582 7-8 7a9 9 0 0 1-2.347-.306c-.52.263-1.639.742-3.468 1.105"></path>
    </svg>
</button>
<!-- The Modal -->
<div class="modal" id="myModal">
    <div class="modal-dialog">
        <div class="modal-content">

            <!-- Modal Header -->
            <div class="modal-header">
                <h6 class="modal-title text-body">Welcome to our Chatbot! üìù </h6>
                <button type="button" class="close" data-dismiss="modal">&times;</button>
            </div>
            <div id="js-chatbot-output" style="display:none"></div>

            <!-- Modal Body -->
            <div class="modal-body assistant-model-content text-body">
                <div class="js-chatbot-content text-body">
                    <b class="text-primary">Assistant</b>
                    <p class="text-body">Hi <span class="wave">üëãüèæ</span> I am Lokie!<br>
                        I'm here to help you summarize the document quickly and efficiently.<br> Just provide me with
                        the text you want to summarize, and I'll extract the most important information for you.<br>
                        Here are sample queries you can try:<br>
                        1. "Can you summarize this document?"<br>
                        2. "I need a summary for this document in 10 points"<br>
                        3. "What are the benefits?"<br>
                        Feel free to ask any question or provide text you'd like summarized, and I'll do my best to help
                        you out!
                    </p>
                </div>
                <input type="textarea" class="js-chatbot-message" placeholder="Type your message here..." style="width:300px;height:30px"></input>
                <button type="submit" class="btn btn-primary js-chatbot-submit">Seach</button>
                <div class="spinner-border d-none" id="spinner" role="status">
                    Loading...
                    <span class="sr-only">Loading...</span>
                </div>
            </div>

            <!-- Modal Footer -->
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary js-chatbot-clear" data-dismiss="modal">Clear</button>
                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
<script>
    // Function to extract text from each page of PDF
    window.onload = function () {
        async function extractTextFromPDF(url) {
            const loadingTask = pdfjsLib.getDocument(url);

            try {
                const pdf = await loadingTask.promise;
                const numPages = pdf.numPages;
                const outputDiv = document.getElementById('js-chatbot-output');
                outputDiv.innerHTML = '';
                console.log('output div cleared');// Clear previous content

                // Iterate through each page
                for (let pageNumber = 1; pageNumber <= numPages; pageNumber++) {
                    const page = await pdf.getPage(pageNumber);
                    const textContent = await page.getTextContent();
                    const pageText = textContent.items.map(function (item) {
                        return item.str;
                    }).join(' ');

                    // Display the text content of the page
                    const pageDiv = document.createElement('div');
                    pageDiv.innerHTML = '<h3>Page ' + pageNumber + '</h3><p>' + pageText + '</p>';
                    outputDiv.appendChild(pageDiv);
                    console.log('Loaded output div',pageDiv);
                }
            } catch (error) {
                console.error('Error loading PDF:', error);
                const outputDiv = document.getElementById('output');
                outputDiv.innerHTML = 'Error loading PDF: ' + error.message;
            }
        }

        const pdfUrl = document.querySelector('.cmp-pdfviewer')?.dataset?.cmpDocumentPath;
        console.log('pdfurl', pdfUrl);
        if (pdfUrl) {
            extractTextFromPDF(pdfUrl);
        }
    }
</script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Get the modal
        var modal = document.getElementById("myModal");

        // Get the modal dialog
        var modalDialog = modal.querySelector('.modal-header');

        var isDragging = false;
        var offset = {x: 0, y: 0};

        // Function to handle mouse down event
        function mouseDownHandler(e) {
            isDragging = true;
            var modalRect = modal.getBoundingClientRect();
            offset.x = e.clientX - modalRect.left;
            offset.y = e.clientY - modalRect.top;
        }

        // Function to handle mouse move event
        function mouseMoveHandler(e) {
            if (isDragging) {
                modalDialog.style.margin = 0;
                modal.style.top = (e.clientY - offset.y) + 'px';
                modal.style.left = (e.clientX - offset.x) + 'px';
            }
        }

        // Function to handle mouse up event
        function mouseUpHandler() {
            isDragging = false;
        }

        // Add event listeners
        modalDialog.addEventListener('mousedown', mouseDownHandler);
        document.addEventListener('mousemove', mouseMoveHandler);
        document.addEventListener('mouseup', mouseUpHandler);
    });
</script>